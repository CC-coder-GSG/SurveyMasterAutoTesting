name: WeCom Notify (Push + PR + Merge)

on:
  # 1) push åˆ°æŒ‡å®šåˆ†æ”¯é€šçŸ¥
  push:
    branches:
      - dev
      - 'release/*'
      - main
      - dubhe
      - merak
      - phecda

  # 2) PR ç”Ÿå‘½å‘¨æœŸé€šçŸ¥ï¼ˆåˆ›å»º/å¯å®¡/é‡æ–°æ‰“å¼€/åˆå¹¶ï¼‰
  pull_request:
    types: [opened, reopened, ready_for_review, closed]
    branches: [main]

jobs:
  notify_push:
    if: ${{ github.event_name == 'push' }}
    runs-on: ubuntu-latest
    steps:
      - name: Send push message to WeCom
        env:
          WECOM_WEBHOOK: ${{ secrets.WECOM_WEBHOOK }}
        run: |
          set -e

          # åŸºæœ¬ä¿¡æ¯
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          ACTOR="${{ github.actor }}"
          COMPARE_URL="${{ github.event.compare }}"
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          # commit ä¿¡æ¯ï¼ˆæœ€å¤šå– 5 æ¡ï¼Œé¿å…åˆ·å±è¿‡é•¿ï¼‰
          COMMITS_JSON='${{ toJson(github.event.commits) }}'
          MSG=$(python3 - <<'PY'
          import json, os
          commits = json.loads(os.environ.get("COMMITS_JSON","[]"))
          lines=[]
          for c in commits[:5]:
              msg = (c.get("message") or "").split("\n")[0]
              sha = (c.get("id") or "")[:7]
              author = (c.get("author",{}).get("name") or "")
              lines.append(f"- `{sha}` {msg} ({author})")
          if len(commits) > 5:
              lines.append(f"- ...and {len(commits)-5} more")
          print("\n".join(lines) if lines else "- (no commit details)")
          PY
          )

          # æ„å»º JSON (ä½¿ç”¨ jq é¿å…ç‰¹æ®Šå­—ç¬¦å¯¼è‡´ JSON æ ¼å¼é”™è¯¯)
          CONTENT="ğŸš€ **Push é€šçŸ¥**
          > Repo: ${REPO}
          > Branch: **${BRANCH}**
          > By: ${ACTOR}
          > Compare: [æŸ¥çœ‹å˜æ›´](${COMPARE_URL})
          
          **Commits:**
          ${MSG}"
          
          jq -n --arg content "$CONTENT" '{msgtype: "markdown", markdown: {content: $content}}' > payload.json

          # å‘é€
          curl -sS "${WECOM_WEBHOOK}" \
            -H 'Content-Type: application/json' \
            -d @payload.json

  notify_pr:
    if: ${{ github.event_name == 'pull_request' && github.event.action != 'closed' }}
    runs-on: ubuntu-latest
    steps:
      - name: Send PR created/ready message to WeCom
        env:
          WECOM_WEBHOOK: ${{ secrets.WECOM_WEBHOOK }}
        run: |
          set -e

          REPO="${{ github.repository }}"
          ACTION="${{ github.event.action }}"
          TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_NUM="${{ github.event.pull_request.number }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          BASE="${{ github.event.pull_request.base.ref }}"
          HEAD="${{ github.event.pull_request.head.ref }}"
          DRAFT="${{ github.event.pull_request.draft }}"

          if [ "${ACTION}" = "opened" ]; then
            EMOJI="ğŸ†•"
            TAG="PR åˆ›å»º"
          elif [ "${ACTION}" = "reopened" ]; then
            EMOJI="ğŸ”„"
            TAG="PR é‡æ–°æ‰“å¼€"
          elif [ "${ACTION}" = "ready_for_review" ]; then
            EMOJI="ğŸ‘€"
            TAG="PR å¯è¯„å®¡"
          else
            EMOJI="ğŸ“Œ"
            TAG="PR æ›´æ–°"
          fi

          # è‰ç¨¿ PR çš„æç¤º
          if [ "${DRAFT}" = "true" ]; then
            DRAFT_NOTE="ï¼ˆDraftï¼‰"
          else
            DRAFT_NOTE=""
          fi

          CONTENT="${EMOJI} **${TAG}** ${DRAFT_NOTE}
          > Repo: ${REPO}
          > PR: #${PR_NUM} [${TITLE}](${PR_URL})
          > From: ${HEAD} â†’ To: **${BASE}**
          > Author: ${AUTHOR}
          
          è¯·å°½å¿«å®‰æ’è¯„å®¡ âœ…"

          jq -n --arg content "$CONTENT" '{msgtype: "markdown", markdown: {content: $content}}' > payload.json

          curl -sS "${WECOM_WEBHOOK}" \
            -H 'Content-Type: application/json' \
            -d @payload.json

  notify_merge_main:
    # åªåœ¨ PR è¢«åˆå¹¶æ—¶é€šçŸ¥ï¼ˆclosed ä¹ŸåŒ…å«â€œå…³é—­ä½†æœªåˆå¹¶â€çš„æƒ…å†µï¼‰
    if: ${{ github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true }}
    runs-on: ubuntu-latest
    steps:
      - name: Send merge-to-main message to WeCom
        env:
          WECOM_WEBHOOK: ${{ secrets.WECOM_WEBHOOK }}
        run: |
          set -e

          REPO="${{ github.repository }}"
          TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_NUM="${{ github.event.pull_request.number }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          MERGER="${{ github.actor }}"
          BASE="${{ github.event.pull_request.base.ref }}"
          HEAD="${{ github.event.pull_request.head.ref }}"
          MERGE_SHA="${{ github.event.pull_request.merge_commit_sha }}"

          CONTENT="âœ… **å·²åˆå¹¶åˆ° ${BASE}**
          > Repo: ${REPO}
          > PR: #${PR_NUM} [${TITLE}](${PR_URL})
          > From: ${HEAD} â†’ To: **${BASE}**
          > Author: ${AUTHOR}
          > Merged by: ${MERGER}
          > Merge Commit: \`${MERGE_SHA:0:7}\`"

          jq -n --arg content "$CONTENT" '{msgtype: "markdown", markdown: {content: $content}}' > payload.json

          curl -sS "${WECOM_WEBHOOK}" \
            -H 'Content-Type: application/json' \
            -d @payload.json
